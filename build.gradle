buildscript {
    repositories {
        mavenCentral()
        maven { url "https://oss.sonatype.org/content/repositories/releases/" }
        maven { url "https://oss.sonatype.org/content/repositories/snapshots/" }
    }
    dependencies {
        classpath "org.elasticsearch.gradle:build-tools:${elasticsearchVersion}"
    }
}

apply plugin: 'java'
apply plugin: 'elasticsearch.esplugin'
apply plugin: 'elasticsearch.yaml-rest-test'

// Java version configuration
java {
    sourceCompatibility = JavaVersion.VERSION_17
    targetCompatibility = JavaVersion.VERSION_17
}

compileJava {
    options.encoding = 'UTF-8'
    options.release = 17
}

esplugin {
    name 'tibetan-analyzer-plugin'
    description 'A Tibetan language analyzer for Elasticsearch based on longest-match algorithm'
    classname 'org.tocharian.TibetanAnalyzerPlugin'
    licenseFile rootProject.file('LICENSE')
    noticeFile rootProject.file('NOTICE.txt')
}

group 'org.tocharian'
version 'v1.0-es8.7+'

// Custom archive file names
tasks.withType(Zip) {
    archiveBaseName = 'tibetan-analyzer-plugin'
    archiveVersion = 'v1.0-es8.7+'
}

repositories {
    mavenLocal()
    mavenCentral()
    maven { url "https://oss.sonatype.org/content/repositories/releases/" }
    maven { url "https://oss.sonatype.org/content/repositories/snapshots/" }
}

dependencies {
    compileOnly "org.elasticsearch.plugin:elasticsearch-plugin-api:${elasticsearchVersion}"
    compileOnly "org.elasticsearch.plugin:elasticsearch-plugin-analysis-api:${elasticsearchVersion}"
    compileOnly "org.elasticsearch:elasticsearch:${elasticsearchVersion}"
    compileOnly "org.apache.lucene:lucene-core:${luceneVersion}"
    compileOnly "org.apache.lucene:lucene-analysis-common:${luceneVersion}"

    testImplementation "org.elasticsearch.plugin:elasticsearch-plugin-api:${elasticsearchVersion}"
    testImplementation "org.elasticsearch.plugin:elasticsearch-plugin-analysis-api:${elasticsearchVersion}"
    testImplementation "org.elasticsearch:elasticsearch:${elasticsearchVersion}"
    testImplementation "org.apache.lucene:lucene-core:${luceneVersion}"
    testImplementation "org.apache.lucene:lucene-analysis-common:${luceneVersion}"

    testImplementation ('junit:junit:4.13.2') {
        exclude group: 'org.hamcrest'
    }
    testImplementation 'org.mockito:mockito-core:4.4.0'
    testImplementation 'org.hamcrest:hamcrest:2.2'
}

task setupEnvironment {
    doLast {
        def osName = System.getProperty('os.name').toLowerCase()
        def isWindows = osName.contains('win')
        def isMac = osName.contains('mac')
        def isLinux = osName.contains('nux')
        def arch = System.getProperty('os.arch')
        def isArm = arch == 'aarch64'
        
        if (isWindows) {
            println 'Configuring for Windows'
        } else if (isMac) {
            if (isArm) {
                println 'Configuring for macOS ARM'
            } else {
                println 'Configuring for macOS Intel'
            }
        } else if (isLinux) {
            if (isArm) {
                println 'Configuring for Linux ARM'
            } else {
                println 'Configuring for Linux x86'
            }
        } else {
            throw new GradleException("Unsupported operating system: ${osName}")
        }
    }
}

assemble.dependsOn setupEnvironment

